{% extends 'base.html.twig' %}
{% block body %}
	{% include 'components/_header.html.twig' %}

	<div id="map" style="height: calc(95vh - 120px); width: 100%;"></div>

	<!-- Bouton flottant -->
	{% if is_granted('ROLE_PROFESSOR', 'ROLE_ADMIN') %}
		<button class="btn-floating" data-bs-toggle="modal" data-bs-target="#createRoomModal">+</button>
		{% else %}
	{% endif %}

	<!-- Modale de création -->
	<div class="modal fade" id="createRoomModal" tabindex="-1" aria-labelledby="createRoomModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Créer un événement</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
				</div>
				<div class="modal-body">
					{{ form_start(form) }}
					{{ form_row(form.title) }}
					{{ form_row(form.description) }}
					{{ form_row(form.date) }}
					{{ form_row(form.language) }}
					{{ form_row(form.latitude) }}
					{{ form_row(form.longitude) }}
					<div id="modal-map" style="height: 300px;"></div>
					<button class="btn btn-success mt-3">Créer</button>
					{{ form_end(form) }}
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="roomInfoModal" tabindex="-1" aria-labelledby="roomInfoModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content shadow rounded-4">
				<div class="modal-header bg-light border-bottom-0">
					<div class="d-flex align-items-center gap-3">
						<span id="modalRoomEmoji" style="font-size: 2rem;"></span>
						<div>
							<h5 class="modal-title mb-0" id="modalRoomTitle"></h5>
							<small class="text-muted" id="modalRoomLanguage"></small>
						</div>
					</div>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
				</div>
				<div class="modal-body">
					<p id="modalRoomDescription" class="mb-3"></p>
					<p class="mb-1">
						<strong>Date :</strong>
						<span id="modalRoomDate"></span>
					</p>
					<p class="mb-3">
						<strong>Places restantes :</strong>
						<span id="modalRoomSlots"></span>
					</p>

					<div>
						<strong>Participants :</strong>
						<div id="modalRoomParticipants" class="mt-2 d-flex flex-column gap-2"></div>
					</div>
				</div>
				<div class="modal-footer border-top-0">
					<a id="joinRoomLink" class="btn btn-primary w-100">Rejoindre l'activité</a>
				</div>
			</div>
		</div>
	</div>

	<div
		class="d-flex">
		<!-- SIDEBAR -->
		<aside id="room-sidebar">
			<h4>Événements récents</h4>

			<!-- Filtres -->
			<div class="filters">
				<input type="text" id="search-title" class="form-control mb-2" placeholder="Rechercher par titre..." value="{{ filter_title }}"/>

				<select id="filter-language" class="form-select mb-2">
					<option value="">Toutes les langues</option>
					{% set languages = [] %}
					{% for room in rooms %}
						{% if room.language and room.language.name not in languages %}
							{% set languages = languages|merge([room.language.name]) %}
							<option value="{{ room.language.name }}" {% if room.language.name == filter_language %} selected {% endif %}>{{ room.language.name }}</option>
						{% endif %}
					{% endfor %}
				</select>

				<input type="date" id="filter-date" class="form-control mb-3" value="{{ filter_date }}"/>
			</div>

			<!-- Liste des rooms -->
			<div id="room-list">
				{% for room in rooms|slice(0, 10) %}
					<div class="room-card" data-title="{{ room.title|lower }}" data-lang="{{ room.language.name|lower }}" data-date="{{ room.date|date('Y-m-d') }}">
						<strong>{{ room.title }}</strong>
						<p class="mb-1">
							<small>{{ room.date|date('d/m/Y H:i') }}</small>
						</p>
						<span class="badge bg-secondary">{{ room.language.name ?? 'Langue inconnue' }}</span>
					</div>
				{% endfor %}
			</div>
		</aside>

		<!-- MAP -->
		<div id="map-container">
			<div id="map"></div>
		</div>
	</div>

	<script type="module">
		import {initMap} from '{{ asset('js/map.js') }}';
import {initModalMap} from '{{ asset('js/modal-map.js') }}';
import '{{ asset('js/filters.js') }}';

window.currentUserId = {{ currentUserId|default('null') }};
window.joinRoomUrlTemplate = "{{ path('app_room_join', {'id': 'ROOM_ID'}) }}";

function loadGoogleMaps() {
return new Promise((resolve) => {
if (window.google && window.google.maps) {
resolve();
} else {
const script = document.createElement('script');
script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyCOpwx5ojbAn5ysXe5aTEU40ygMHG_kfwU';
script.async = true;
script.defer = true;
script.onload = () => resolve();
document.head.appendChild(script);
}
});
}


document.addEventListener('DOMContentLoaded', async () => {
await loadGoogleMaps();
initMap({{ rooms|json_encode|raw }});
initModalMap('createRoomModal', 'modal-map', 'room_latitude', 'room_longitude');
});
	</script>

	{% include 'components/_footer.html.twig' %}
{% endblock %}
